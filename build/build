#!/usr/bin/env bash

set -e

# Builds 'service-mail' docker image with the version given below. 

# Determine the build_tag and whether we need to release.
scripts/build_name
version=$(cat build_tag)

# Create a release.tar that contains all the code. 
pushd ..
tar cf build/release.tar \
  --exclude .git \
  --exclude node_modules \
  --exclude */node_modules \
  --exclude build \
  .
popd

host='eu.gcr.io'

echo "---------------------------- building mail ------------------------------"
pushd mail
cp ../release.tar .
docker build -f Dockerfile -t $host/pryvio/mail:$version .
docker push $host/pryvio/mail:$version
popd
